# LCARS Computer - ESPHome Voice Satellite Configuration
# ESP32-S3-BOX-3 Configuration
#
# This configuration file sets up an ESP32-S3-BOX-3 device as a voice satellite
# for the LCARS Computer system. The device handles:
#   - Wake word detection ("Computer")
#   - Audio capture and streaming via Wyoming protocol
#   - Visual feedback via the onboard display
#   - Audio playback for TTS responses
#
# Prerequisites:
#   - ESPHome 2024.2.0 or newer
#   - Home Assistant with ESPHome integration
#   - Wyoming protocol services running (Whisper, Piper, openWakeWord)
#
# Installation:
#   1. Flash this configuration to your ESP32-S3-BOX-3 via ESPHome
#   2. Add the device to Home Assistant
#   3. Configure the Assist pipeline to use this satellite

# Substitutions allow easy customization of the device name and room assignment.
# Change these values to match your deployment.
substitutions:
  # Unique name for this satellite (used in Home Assistant entity IDs)
  name: "voice-satellite-living-room"
  # Human-readable name shown in the Home Assistant UI
  friendly_name: "Living Room Computer Terminal"
  # The room where this satellite is located (used for room-aware responses)
  room: "living_room"

# ESPHome core configuration
esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  # Minimum ESPHome version required for this configuration
  min_version: 2024.2.0
  # Project metadata for ESPHome dashboard
  project:
    name: lcars.voice-satellite
    version: "1.0.0"
  # Run on boot to initialize the display
  on_boot:
    priority: 600
    then:
      - light.turn_on:
          id: led_ring
          brightness: 30%
          effect: "Slow Pulse"
      - delay: 2s
      - lambda: |-
          id(display_component).clear();
          id(display_component).printf(160, 100, id(font_title), COLOR_ON, TextAlign::CENTER, "LCARS");
          id(display_component).printf(160, 140, id(font_body), COLOR_ON, TextAlign::CENTER, "Computer Terminal");
          id(display_component).printf(160, 180, id(font_body), COLOR_ON, TextAlign::CENTER, "Ready");

# ESP32-S3 board configuration for the S3-BOX-3
esp32:
  board: esp32s3box
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      # Enable PSRAM for audio buffering (S3-BOX-3 has 8MB PSRAM)
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_SPIRAM_SUPPORT: "y"
      CONFIG_SPIRAM_MODE_OCT: "y"
      CONFIG_SPIRAM_SPEED_80M: "y"

# Enable PSRAM for extended memory (critical for audio processing)
psram:
  mode: octal
  speed: 80MHz

# Logging configuration - reduce verbosity for production use
logger:
  level: INFO
  # Disable logging via UART to reduce interference with audio
  baud_rate: 0

# WiFi configuration - uses Home Assistant secrets for security
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Power saving disabled for responsive voice detection
  power_save_mode: none
  # Fallback hotspot for initial configuration
  ap:
    ssid: "LCARS-Terminal-Setup"
    password: "computer123"

# Enable captive portal for fallback AP
captive_portal:

# Home Assistant API connection
api:
  # Encryption key for secure communication with Home Assistant
  encryption:
    key: !secret api_encryption_key
  # Expose services for control from Home Assistant
  services:
    # Service to trigger a custom announcement
    - service: announce
      variables:
        message: string
      then:
        - lambda: |-
            id(display_component).clear();
            id(display_component).printf(160, 120, id(font_body), COLOR_ON, TextAlign::CENTER, "%s", message.c_str());
        - delay: 5s

# Over-the-air update support
ota:
  platform: esphome
  password: !secret ota_password

# I2C bus configuration for peripherals
i2c:
  sda: GPIO8
  scl: GPIO18
  scan: true
  id: bus_a

# I2S audio configuration for the S3-BOX-3
# The S3-BOX-3 has high-quality onboard microphones and speaker
i2s_audio:
  - id: i2s_audio_bus
    i2s_lrclk_pin: GPIO45
    i2s_bclk_pin: GPIO17

# Microphone configuration for voice capture
microphone:
  - platform: i2s_audio
    id: board_microphone
    adc_type: external
    i2s_din_pin: GPIO16
    pdm: false
    i2s_audio_id: i2s_audio_bus
    bits_per_sample: 32bit
    channel: left

# Speaker configuration for TTS playback
speaker:
  - platform: i2s_audio
    id: board_speaker
    dac_type: external
    i2s_dout_pin: GPIO15
    i2s_audio_id: i2s_audio_bus
    mode: mono

# Media player component for TTS integration
media_player:
  - platform: i2s_audio
    id: media_player_speaker
    name: "${friendly_name} Speaker"
    dac_type: external
    i2s_dout_pin: GPIO15
    i2s_audio_id: i2s_audio_bus
    mode: mono

# Voice Assistant configuration - the core of the satellite functionality
voice_assistant:
  id: voice_assistant_component
  microphone: board_microphone
  speaker: board_speaker
  # Volume multiplier for the speaker output
  volume_multiplier: 2.0
  # Noise suppression level (higher = more aggressive filtering)
  noise_suppression_level: 2
  # Automatic gain control for consistent audio levels
  auto_gain: 31dBFS
  
  # Wake word detection using openWakeWord running on the server
  use_wake_word: true
  
  # Event handlers for visual and audio feedback
  on_wake_word_detected:
    - light.turn_on:
        id: led_ring
        brightness: 100%
        effect: "Fast Pulse"
    - lambda: |-
        id(display_component).clear();
        id(display_component).printf(160, 120, id(font_title), COLOR_ON, TextAlign::CENTER, "Listening...");
  
  on_listening:
    - light.turn_on:
        id: led_ring
        brightness: 100%
        effect: "Solid"
        red: 0%
        green: 100%
        blue: 50%
  
  on_stt_vad_end:
    - light.turn_on:
        id: led_ring
        effect: "Thinking"
    - lambda: |-
        id(display_component).clear();
        id(display_component).printf(160, 120, id(font_title), COLOR_ON, TextAlign::CENTER, "Processing...");
  
  on_tts_start:
    - light.turn_on:
        id: led_ring
        brightness: 80%
        effect: "Solid"
        red: 0%
        green: 50%
        blue: 100%
    - lambda: |-
        id(display_component).clear();
        id(display_component).printf(160, 120, id(font_title), COLOR_ON, TextAlign::CENTER, "Speaking...");
  
  on_tts_end:
    - light.turn_on:
        id: led_ring
        brightness: 30%
        effect: "Slow Pulse"
    - lambda: |-
        id(display_component).clear();
        id(display_component).printf(160, 120, id(font_title), COLOR_ON, TextAlign::CENTER, "Ready");
  
  on_error:
    - light.turn_on:
        id: led_ring
        brightness: 100%
        effect: "Solid"
        red: 100%
        green: 0%
        blue: 0%
    - delay: 2s
    - light.turn_on:
        id: led_ring
        brightness: 30%
        effect: "Slow Pulse"
    - lambda: |-
        id(display_component).clear();
        id(display_component).printf(160, 100, id(font_title), COLOR_ON, TextAlign::CENTER, "Error");
        id(display_component).printf(160, 140, id(font_body), COLOR_ON, TextAlign::CENTER, "Unable to process");

# LED ring for visual feedback (the S3-BOX-3 has addressable LEDs)
light:
  - platform: esp32_rmt_led_strip
    id: led_ring
    name: "${friendly_name} LED"
    pin: GPIO47
    num_leds: 1
    rmt_channel: 0
    chipset: WS2812
    rgb_order: GRB
    effects:
      - pulse:
          name: "Slow Pulse"
          transition_length: 1s
          update_interval: 1s
      - pulse:
          name: "Fast Pulse"
          transition_length: 250ms
          update_interval: 250ms
      - strobe:
          name: "Thinking"
          colors:
            - state: true
              brightness: 100%
              red: 0%
              green: 100%
              blue: 100%
              duration: 250ms
            - state: true
              brightness: 50%
              red: 0%
              green: 50%
              blue: 100%
              duration: 250ms

# Display configuration for the S3-BOX-3's LCD screen
# The LCARS-style interface provides visual feedback
spi:
  clk_pin: GPIO7
  mosi_pin: GPIO6

display:
  - platform: ili9xxx
    id: display_component
    model: ST7789V
    cs_pin: GPIO5
    dc_pin: GPIO4
    reset_pin: GPIO48
    dimensions:
      height: 240
      width: 320
      offset_height: 0
      offset_width: 0
    rotation: 0
    update_interval: never
    data_rate: 80MHz

# Font definitions for the display
font:
  - file: "gfonts://Roboto"
    id: font_title
    size: 28
  - file: "gfonts://Roboto"
    id: font_body
    size: 18

# Color definitions (LCARS-inspired orange/amber)
color:
  - id: color_lcars_orange
    hex: "FF9900"
  - id: color_lcars_blue
    hex: "9999FF"

# Physical button on the S3-BOX-3 for manual wake
binary_sensor:
  - platform: gpio
    id: button_boot
    pin:
      number: GPIO0
      mode: INPUT_PULLUP
      inverted: true
    name: "${friendly_name} Button"
    on_press:
      # Manual activation of voice assistant
      - voice_assistant.start:
    on_release:
      - voice_assistant.stop:

# Sensors for monitoring device health
sensor:
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s
  
  - platform: uptime
    name: "${friendly_name} Uptime"
    update_interval: 60s

# Text sensor for diagnostic information
text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"
    ssid:
      name: "${friendly_name} SSID"

# Switch to enable/disable the voice assistant
switch:
  - platform: template
    id: use_wake_word_switch
    name: "${friendly_name} Wake Word"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on:
      - voice_assistant.start_continuous:
    on_turn_off:
      - voice_assistant.stop:
