# LCARS Computer - ESPHome Voice Satellite Configuration
# M5Stack Atom Echo (Budget Option)
#
# This configuration sets up the compact M5Stack Atom Echo as a voice
# satellite for the LCARS Computer system. The Atom Echo is a cost-effective
# option at around $15, making it ideal for secondary rooms or areas where
# a full ESP32-S3-BOX-3 would be overkill.
#
# Features:
#   - Wake word detection ("Computer")
#   - Audio capture via built-in PDM microphone
#   - Audio playback via built-in speaker
#   - LED status indicator
#
# Limitations compared to ESP32-S3-BOX-3:
#   - No display screen
#   - Single LED instead of LED ring
#   - Lower quality microphone (works best in quieter environments)
#   - No hardware echo cancellation
#
# Hardware: M5Stack Atom Echo
#   - ESP32 Pico D4
#   - PDM Microphone (SPM1423)
#   - Speaker (NS4168 I2S amplifier)
#   - RGB LED (SK6812)
#   - Single button
#
# Installation:
#   1. Flash this configuration using ESPHome
#   2. Add the device to Home Assistant
#   3. Configure the Assist pipeline to use this satellite

substitutions:
  name: "voice-satellite-kitchen"
  friendly_name: "Kitchen Computer Terminal"
  room: "kitchen"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  min_version: 2024.2.0
  project:
    name: lcars.voice-satellite-atom
    version: "1.0.0"
  # Initialize the LED on boot to indicate the device is ready
  on_boot:
    priority: 600
    then:
      - light.turn_on:
          id: status_led
          brightness: 50%
          red: 0%
          green: 100%
          blue: 50%
      - delay: 2s
      - light.turn_on:
          id: status_led
          brightness: 20%
          effect: "Slow Pulse"

# ESP32 board configuration for the M5Stack Atom series
esp32:
  board: m5stack-atom
  framework:
    type: esp-idf
    version: recommended

# Logging configuration - keep minimal for production stability
logger:
  level: INFO
  # Disable serial logging to prevent interference with audio
  baud_rate: 0

# WiFi configuration using Home Assistant secrets
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: light
  # Fallback hotspot for initial setup
  ap:
    ssid: "LCARS-Atom-Setup"
    password: "computer123"

captive_portal:

# Home Assistant API with encryption
api:
  encryption:
    key: !secret api_encryption_key

# Over-the-air updates
ota:
  platform: esphome
  password: !secret ota_password

# I2S audio bus configuration for the Atom Echo
# The Atom Echo uses a slightly different pin configuration than the S3-BOX-3
i2s_audio:
  - id: i2s_audio_bus
    i2s_lrclk_pin: GPIO33
    i2s_bclk_pin: GPIO19

# Microphone configuration - the Atom Echo uses a PDM microphone
microphone:
  - platform: i2s_audio
    id: atom_microphone
    adc_type: external
    i2s_din_pin: GPIO23
    pdm: true
    i2s_audio_id: i2s_audio_bus
    bits_per_sample: 32bit

# Speaker configuration for TTS output
speaker:
  - platform: i2s_audio
    id: atom_speaker
    dac_type: external
    i2s_dout_pin: GPIO22
    i2s_audio_id: i2s_audio_bus
    mode: mono

# Media player for integration with Home Assistant TTS
media_player:
  - platform: i2s_audio
    id: atom_media_player
    name: "${friendly_name} Speaker"
    dac_type: external
    i2s_dout_pin: GPIO22
    i2s_audio_id: i2s_audio_bus
    mode: mono

# Voice Assistant - the core functionality for wake word detection
# and conversation handling
voice_assistant:
  id: voice_assistant_component
  microphone: atom_microphone
  speaker: atom_speaker
  # Volume boost to compensate for small speaker
  volume_multiplier: 3.0
  # Noise suppression helps with the lower-quality microphone
  noise_suppression_level: 3
  auto_gain: 31dBFS
  
  use_wake_word: true
  
  # Visual feedback through the status LED
  on_wake_word_detected:
    - light.turn_on:
        id: status_led
        brightness: 100%
        effect: "Fast Pulse"
  
  on_listening:
    - light.turn_on:
        id: status_led
        brightness: 100%
        red: 0%
        green: 100%
        blue: 0%
        effect: "none"
  
  on_stt_vad_end:
    - light.turn_on:
        id: status_led
        brightness: 80%
        red: 0%
        green: 50%
        blue: 100%
        effect: "Pulse"
  
  on_tts_start:
    - light.turn_on:
        id: status_led
        brightness: 60%
        red: 0%
        green: 50%
        blue: 100%
        effect: "none"
  
  on_tts_end:
    - light.turn_on:
        id: status_led
        brightness: 20%
        effect: "Slow Pulse"
  
  on_error:
    - light.turn_on:
        id: status_led
        brightness: 100%
        red: 100%
        green: 0%
        blue: 0%
        effect: "none"
    - delay: 3s
    - light.turn_on:
        id: status_led
        brightness: 20%
        effect: "Slow Pulse"

# RGB LED configuration for status indication
# The Atom Echo has a single SK6812 RGB LED
light:
  - platform: esp32_rmt_led_strip
    id: status_led
    name: "${friendly_name} Status LED"
    pin: GPIO27
    num_leds: 1
    rmt_channel: 0
    chipset: SK6812
    rgb_order: GRB
    # Default to a dim green "ready" state
    restore_mode: ALWAYS_OFF
    effects:
      - pulse:
          name: "Slow Pulse"
          transition_length: 1.5s
          update_interval: 1.5s
          min_brightness: 10%
          max_brightness: 40%
      - pulse:
          name: "Fast Pulse"
          transition_length: 200ms
          update_interval: 200ms
          min_brightness: 50%
          max_brightness: 100%
      - pulse:
          name: "Pulse"
          transition_length: 500ms
          update_interval: 500ms

# Physical button on the Atom Echo for manual activation
# A single press activates the voice assistant without needing the wake word
binary_sensor:
  - platform: gpio
    id: atom_button
    pin:
      number: GPIO39
      inverted: true
    name: "${friendly_name} Button"
    # Short press: Manual voice activation
    on_press:
      - voice_assistant.start:
    on_release:
      - voice_assistant.stop:
    # Long press (3 seconds): Toggle wake word listening
    on_multi_click:
      - timing:
          - ON for at least 3s
        then:
          - switch.toggle: use_wake_word_switch

# Diagnostic sensors for monitoring device health
sensor:
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s
  
  - platform: uptime
    name: "${friendly_name} Uptime"
    update_interval: 60s
  
  # Internal temperature monitoring (ESP32 has a built-in sensor)
  - platform: internal_temperature
    name: "${friendly_name} Internal Temperature"
    update_interval: 60s

# Network information for diagnostics
text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"
    ssid:
      name: "${friendly_name} SSID"
    mac_address:
      name: "${friendly_name} MAC Address"

# Switch to enable/disable wake word detection
# Useful for muting the device without unplugging it
switch:
  - platform: template
    id: use_wake_word_switch
    name: "${friendly_name} Wake Word Enabled"
    icon: "mdi:microphone"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on:
      - voice_assistant.start_continuous:
      - light.turn_on:
          id: status_led
          brightness: 20%
          red: 0%
          green: 100%
          blue: 50%
          effect: "Slow Pulse"
    on_turn_off:
      - voice_assistant.stop:
      - light.turn_on:
          id: status_led
          brightness: 10%
          red: 100%
          green: 50%
          blue: 0%
          effect: "none"
  
  # Restart switch for remote troubleshooting
  - platform: restart
    name: "${friendly_name} Restart"
