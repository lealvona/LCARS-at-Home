# Deployment Tab Updates (Streamlit Installer)

Date: 2026-01-02

This document summarizes recent improvements to the **Deployment** tab in the Streamlit installer.

## Goals

1. Prevent the Deployment tab from feeling like it “refreshes” and losing UI state on every toggle.
2. Make **custom deployment** actually apply the user-entered **existing service host/port** settings.
3. Persist “Auto-Detect Services” results across reruns so the output doesn’t disappear.

## Summary of Changes

### 1) Reduced disruptive reruns during Custom Deployment configuration

**Problem**: Streamlit reruns the whole script on most widget interactions (checkbox toggles, text input changes). This can collapse expanders and reset scroll position, which looks like a full page refresh.

**Fix**:
- Wrapped the Custom Deployment **Service Configuration** section in a `st.form()` so edits don’t trigger a rerun on every interaction.
- The app now reruns primarily when you click submit actions (e.g., **Test Connection** or **Save Configuration & Continue**).

**Files**:
- `lcars_guide.py`

### 2) Persisted Auto-Detect Services output

**Problem**: Clicking **Auto-Detect Services** would show results, but later reruns (from other UI actions) could make that output disappear.

**Fix**:
- Stored the last discovery results in `st.session_state.deployment_last_discovery`.
- Rendered a “Last scan results” expander even when the button is not pressed, so the last scan remains visible.

**Files**:
- `lcars_guide.py`

### 3) Custom host/port values now affect runtime configuration

**Problem**: The Custom Deployment UI allowed entering host/port for existing services, but the stack configuration didn’t reliably consume those settings.

**Fixes**:

#### 3.1 Update `docker/.env` when saving custom configuration

When you click **Save Configuration & Continue** in Custom Deployment mode, the installer now updates `docker/.env` with the selected endpoints:

- `HA_URL=http://<host>:<port>` when Home Assistant is marked as “use existing”.
- `OLLAMA_BASE_URL=http://<host>:<port>` when Ollama is marked as “use existing”.
  - Otherwise defaults to `http://ollama:11434` for in-stack Open WebUI → Ollama.
- `DB_POSTGRESDB_HOST=<host>` and `DB_POSTGRESDB_PORT=<port>` when PostgreSQL is marked as “use existing”.
  - Otherwise defaults to `postgres` and `5432`.

Implementation detail:
- Introduced an `upsert_env_var()` helper to safely insert/update `KEY=VALUE` lines.

#### 3.2 Generate `docker/docker-compose.override.yml`

When saving custom configuration, the installer now writes `docker/docker-compose.override.yml` based on the selected services:

- Services marked “use existing” are disabled via a Compose profile (`profiles: [disabled]`).
  - This prevents those containers from being started by default.
- Services with custom ports get a `ports:` override mapping.

This is generated by `scripts/deploy_config.py`.

#### 3.3 Make compose files env-driven for key endpoints

Updated Compose files so container configuration uses env vars written above:

- `n8n`:
  - `DB_POSTGRESDB_HOST=${DB_POSTGRESDB_HOST:-postgres}`
  - `DB_POSTGRESDB_PORT=${DB_POSTGRESDB_PORT:-5432}`
- `open-webui`:
  - `OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}`

**Files**:
- `lcars_guide.py`
- `scripts/deploy_config.py`
- `docker/docker-compose.yml`
- `docker/docker-compose.desktop.yml`

### 4) GPU deployment script respects override file

**Problem**: When running GPU mode, the deploy script explicitly used `-f docker-compose.yml -f docker-compose.gpu.yml` and could skip the override file.

**Fix**:
- In GPU mode, `scripts/deploy.sh` now also includes `docker-compose.override.yml` if it exists.

**Files**:
- `scripts/deploy.sh`

## UX Notes / Guidance

### “localhost” vs “host.docker.internal”

In Custom Deployment, if you set an “existing service” host to `localhost` / `127.0.0.1`, the installer now warns you:

- From inside containers, `localhost` refers to the container itself.
- For services running on the Docker host, prefer `host.docker.internal` (this repo’s convention).

### How to use

1. Open the Streamlit installer.
2. Go to **Deployment** → choose **Custom Deployment**.
3. Click **Auto-Detect Services** (optional).
4. For a service you want to reuse, check **Use existing …** and set host/port.
5. Click **Save Configuration & Continue**.
6. Bring the stack up normally (Linux):
   - `cd docker && docker compose up -d`

On Linux, Compose automatically loads `docker-compose.override.yml` when present.

## Validation

- `lcars_guide.py` compiles cleanly (`python -m py_compile lcars_guide.py`).
- `scripts/deploy_config.py` compiles cleanly (`python -m py_compile scripts/deploy_config.py`).
